name: bioloop_cicd
services:
  nginx:
    image: git.sca.iu.edu:5050/${PROJECT_NAME}/nginx:test
    volumes:
      - ui_modules:/usr/share/nginx/html
    ports:
      - "8081:8081"
    expose:
      - 8081
    depends_on:
      - api
      - ui


  ui:
    image: git.sca.iu.edu:5050/${PROJECT_NAME}/ui:test
    env_file:
      - ui.env
    volumes:
      - ui_modules:/opt/sca/app/dist
    depends_on:
      - api
    restart: "no"


  e2e:
    image: git.sca.iu.edu:5050/${PROJECT_NAME}/e2e:test
    env_file:
      - tests.env
    depends_on:
      - api
      - nginx
    entrypoint: [ "tail", "-f", "/dev/null" ]

      
  api:
    image: git.sca.iu.edu:5050/${PROJECT_NAME}/api:test
    env_file:
      - tests.env
      - db.env
      - api.env
    entrypoint:
      - sh
      - -c
      - |
        ./keys/genkeys.sh \
        && npx prisma generate \
        && exec /opt/sca/app/node_modules/.bin/nodemon --signal SIGTERM src/index.js
    expose:
      - 3030
    depends_on:
     - postgres


  postgres:
    image: postgres:14.5
    env_file:
      - db.env
    restart: unless-stopped
    expose:
      - 5432

volumes:
  ui_modules:
    external: false

