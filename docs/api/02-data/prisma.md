# ORM

[Prisma.js](https://www.prisma.io/) is used as the ORM (Object-Relational Mapping) and schema migration tool in this project. It simplifies database interactions by providing a type-safe API and automates schema migrations, ensuring consistency across environments.

The `DATABASE_URL` environment variable is used to connect to the database. This is configured in the `.env` file.

- **Database Schema**: Defined in `prisma/schema.prisma`.
- **Seeding**: Handled by `prisma/seed.js` with additional scripts in the `seed_data` directory.
- **Migration Commands**:
  - `npx prisma migrate dev`: Creates a new migration during development.
  - `npx prisma migrate deploy`: Applies migrations in production.
- **Seeding Command**:
  - `npx prisma db seed`: Seeds the database with initial data.
- **Initialization**: The `db.js` file contains the setup for the Prisma client.

## Importing Prisma Client in Routers and Services

To avoid exhausting database connections in long-running applications (like Express servers), instantiate `PrismaClient` once in a central file (e.g., `db.js`) and import this instance wherever needed.

**`src/db.js`**
```js
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();
module.exports = prisma;
```

**Usage in Routers/Services:**
```js
const prisma = require('@/db');

// Example usage in a route handler
router.get('/users', async (req, res) => {
  const users = await prisma.user.findMany();
  res.json(users);
});
```

For one-off scripts (e.g., seeding), you can instantiate `PrismaClient` directly in the script.

Refer to the [official documentation](https://www.prisma.io/docs/orm/prisma-client/setup-and-configuration/databases-connections#long-running-processes) for best practices.

## Gotchas

### Auto Timestamp

`now()` sets the current timestamp in the UTC time zone. Both `createdAt` and `updatedAt` fields are in UTC timezone. If the database is set to a different timezone, you may see future timestamps when connected to the db using a tool like dbeaver.

This is not a problem when using prisma queries, as prisma automatically converts the timestamps to the local timezone.

```prisma
model Post {
  id               Int                @id @default(autoincrement())
  title            String
  content          String?
  published        Boolean?           @default(false)
  createdAt        DateTime           @default(now()) @db.Timestamp(6)
  updatedAt        DateTime           @updatedAt @default(now()) @db.Timestamp(6)
}
```

- **Important Note**: When performing raw SQL queries, avoid using `createdAt < now()`. Instead, use `createdAt < timezone('utc', now())` to ensure consistent time zone handling.

### Aliasing and Excluding Columns

Prisma does not support aliasing columns (like SQL's `AS` keyword) or excluding specific columns directly. Instead, you can transform the returned objects in JavaScript.

Example:

```javascript
const _ = require('lodash');

function transformUser(user) {
  return _(user)
    .set('roles', user.user_role.map((obj) => obj.roles.name)) // Transform and set new keys
    .omit(['password', 'id', 'user_role']) // Remove unwanted keys
    .value();
}
```

For more details, refer to:
- [GitHub Discussion](https://github.com/prisma/prisma/discussions/14316)
- [Prisma Documentation](https://www.prisma.io/docs/concepts/components/prisma-client/excluding-fields)

### Avoid `SELECT *` Queries

Fetching all columns can negatively impact performance due to deserialization overhead, increased network transmission, and inefficiencies with non-inline columns (e.g., blobs, JSON).

**Bad Example**:
```javascript
const users = await prisma.user.findMany();
```

**Good Example**:
```javascript
const users = await prisma.user.findMany({
  select: {
    id: true,
    name: true,
    email: true,
  },
});
```

For more information, see [this source](https://glasp.co/youtube/p/a-deep-dive-in-how-slow-select-is).

### Sorting with `nulls last`

Prisma's sorting behavior depends on whether a column is nullable. For nullable fields, you must explicitly specify `nulls: 'last'` or `nulls: 'first'`. For non-nullable fields, including this option will throw an error.

Example:

```javascript
const buildOrderByObject = (field, sortOrder, nullsLast = true) => {
  const nullable_order_by_fields = ['du_size', 'size'];

  if (!field || !sortOrder) {
    return {};
  }
  if (nullable_order_by_fields.includes(field)) {
    return {
      [field]: { sort: sortOrder, nulls: nullsLast ? 'last' : 'first' },
    };
  }
  return {
    [field]: sortOrder,
  };
};
```

### Logging Queries

Enable logging to debug and monitor Prisma queries:

```javascript
const prisma = new PrismaClient({
  log: ['query', 'info', 'warn', 'error'],
});
```

This will log all queries, warnings, and errors generated by the Prisma client.