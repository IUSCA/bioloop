import{_ as t,c as a,o as s,ag as o}from"./chunks/framework.C9SxlbOG.js";const i="/bioloop/docs/secure-download-arch-diagram.png",p=JSON.parse('{"title":"Secure Download","description":"","frontmatter":{},"headers":[],"relativePath":"secure_download.md","filePath":"secure_download.md","lastUpdated":null}'),n={name:"secure_download.md"};function r(l,e,d,h,c,u){return s(),a("div",null,e[0]||(e[0]=[o(`<h1 id="secure-download" tabindex="-1">Secure Download <a class="header-anchor" href="#secure-download" aria-label="Permalink to &quot;Secure Download&quot;">​</a></h1><h2 id="table-of-contents" tabindex="-1">Table of Contents <a class="header-anchor" href="#table-of-contents" aria-label="Permalink to &quot;Table of Contents&quot;">​</a></h2><ul><li>Introduction</li><li>Requirements</li><li>Staging the Dataset</li><li>Access Control</li><li>Architecture Overview</li><li>Downloading a Dataset File</li></ul><h2 id="_1-introduction" tabindex="-1">1. Introduction <a class="header-anchor" href="#_1-introduction" aria-label="Permalink to &quot;1. Introduction&quot;">​</a></h2><p>This document provides an overview of the Secure Download functionality, detailing the requirements and architecture of the system. The primary goal is to allow authorized users to download dataset files both directly from the browser and from Slate Scratch while ensuring strict access control to prevent unauthorized access.</p><h2 id="_2-requirements-and-limitations" tabindex="-1">2. Requirements and Limitations <a class="header-anchor" href="#_2-requirements-and-limitations" aria-label="Permalink to &quot;2. Requirements and Limitations&quot;">​</a></h2><p>Users with access to the dataset should be able to download dataset files directly from their web browsers. The file download link should be accessible only to users with the necessary permissions.</p><p>Dataset files must be staged before attempting to download.</p><p>The staged files should be protected from unauthorized users who have access to slate scratch from navigating and/or downloading dataset files.</p><h3 id="_2-1-limitations" tabindex="-1">2.1 Limitations <a class="header-anchor" href="#_2-1-limitations" aria-label="Permalink to &quot;2.1 Limitations&quot;">​</a></h3><p>The UI and API are running on a node where the Slate Scratch path is not mounted, preventing direct file access. An Nginx server is hosted on the colo node, which has access to the staged files. However, configuring Nginx as a simple file server would allow anyone to access any files. However, the download file server cannot determine users&#39;access because the access control data, specifying which users have access to which datasets and files, is maintained by the API in a PostgreSQL database.</p><h2 id="_3-staging-the-dataset" tabindex="-1">3. Staging the Dataset <a class="header-anchor" href="#_3-staging-the-dataset" aria-label="Permalink to &quot;3. Staging the Dataset&quot;">​</a></h2><p>The Staging Dataset functionality allows users to request the download of individual dataset files (or the entire dataset, as a bundled file) through the UI or API. Staging a dataset involves the transfer of the corresponding archived bundle from the SDA (Source Data Archive) to a temporary location known as the Slate Scratch path. This intermediate step ensures efficient and secure access to the dataset while preventing unauthorized access through path enumeration.</p><p>Staging Process:</p><ul><li><p><strong>User Request</strong>: Users initiate a dataset file/bundle download request through either the user interface (UI) or the application programming interface (API).</p></li><li><p><strong>Rhythm Workflow</strong>: The request triggers a rhythm workflow &quot;Stage&quot; on the colo node where the celery tasks are registered. &quot;stage_dataset&quot;, &quot;validate_dataset&quot;, &quot;setup_dataset_download&quot; are the celery tasks involved in this workflow.</p></li><li><p><strong>Path Randomization</strong>: During dataset staging, the path of the staged dataset files/bundle are obfuscated through the means of a random universally unique identifier (UUID) called <code>stage_alias</code>. This UUID is generated to limit access to datasets through path enumeration.</p><ul><li>The <code>stage_dataset</code> celery task downloads the dataset bundle from SDA, and extracts the dataset files and the bundle to their corresponding randomized paths. <ul><li>The dataset&#39;s staging path follows the pattern: <code>&lt;stage_directory&gt;/&lt;dataset_stage_alias&gt;/&lt;dataset_name&gt;</code>.</li><li>The bundle&#39;s staging path follows the pattern: <code>&lt;bundle_stage_directory&gt;/&lt;dataset_bundle_name&gt;</code>.</li></ul></li></ul></li></ul><p>Example:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>/stage_directory/6a5b1734-98e8-4e47-ae5f-1a9e5d8d9f7c/dataset_name</span></span>
<span class="line"><span>/bundle_stage_directory/bundle_name</span></span></code></pre></div><ul><li><strong>Symlink Creation</strong>: Two symlinks are created to facilitate downloads. <ul><li><code>&lt;download_path&gt;/&lt;dataset_stage_alias&gt;</code>. This points to <code>&lt;stage_directory&gt;/&lt;dataset_stage_alias&gt;/&lt;dataset_name&gt;</code>. This will be path given to the users who want to download the dataset files from the Slate Scratch directly.</li><li><code>&lt;download_path&gt;/&lt;dataset_bundle_name&gt;</code>. This points to <code>&lt;bundle_stage_directory&gt;/&lt;dataset_name&gt;</code>. This will be path given to the users who want to download the dataset as a bundle from the Slate Scratch directly.</li></ul></li></ul><p>The file download nginx server is configured to serve files from the <code>&lt;download_path&gt;</code> directory.</p><p>To enhance security, the access control list (ACL) of the <code>&lt;stage_directory&gt;/&lt;dataset_stage_alias&gt;</code> directory is carefully configured. It is limited to granting only the &quot;execute&quot; permission bit (--x) for the &quot;others&quot; group. This permission setup ensures that users with access to the Slate Scratch path cannot browse or navigate through all datasets present in the directory. Instead, only users who possess the complete path <code>&lt;stage_directory&gt;/&lt;dataset_stage_alias&gt;/&lt;dataset_name&gt;</code> are allowed to read the contents of the staged dataset.</p><h4 id="uuid-generation" tabindex="-1">UUID Generation <a class="header-anchor" href="#uuid-generation" aria-label="Permalink to &quot;UUID Generation&quot;">​</a></h4><p>The UUIDs used in the staging paths of the dataset and the bundle are generated deterministically. They are a function of the dataset type, dataset (or bundle) name, and a salt string. This deterministic approach ensures consistency and allows authorized users to access the staged dataset/bundle when needed, while making it computationally infeasible for users to guess the path of other datasets.</p><p>By implementing these measures, the Staging Dataset functionality maintains data security and privacy, preventing unauthorized access and ensuring the integrity of the staged datasets.</p><h2 id="_4-access-control" tabindex="-1">4. Access Control <a class="header-anchor" href="#_4-access-control" aria-label="Permalink to &quot;4. Access Control&quot;">​</a></h2><p>Access control is managed through the project membership and user roles by the API. Users of &quot;operator&quot; and &quot;admin&quot; roles can access any dataset and its files. Users with &quot;user&quot; can only access the datasets that are associated with projects the user is a member of. This role-based access control ensures that sensitive dataset information is only accessible to those who have been explicitly granted access rights.</p><p>To further enhance security and prevent unauthorized access to dataset files, a secure ephemeral resource bound URL is constructed. This URL contains critical components to ensure its validity and security: Components of the Secure URL:</p><ul><li><strong>File Path</strong>: The URL contains the file path relative to the download directory of the dataset file that needs to be downloaded.</li><li><strong>JWT (JSON Web Token)</strong>: A very short-lived JWT is included as part of the URL. The JWT payload includes the file path as one of its components.</li></ul><p>URL Validation:</p><p>For the URL to be considered valid, the following conditions must be met:</p><ul><li>JWT Validity: The JWT included in the URL must be valid, meaning it must have a valid signature and must not be expired.</li><li>Path Match: The file path inside the JWT payload should match the file path specified in the path section of the URL.</li></ul><p>By enforcing these conditions, the system ensures that even if an unauthorized user somehow obtains a link to a dataset file sometime later, they cannot access it. It also makes sure that a token cannot be used to download other files even if it is unexpired and has a valid signature.</p><h2 id="_5-architecture-overview" tabindex="-1">5. Architecture Overview <a class="header-anchor" href="#_5-architecture-overview" aria-label="Permalink to &quot;5. Architecture Overview&quot;">​</a></h2><p>To meet the requirements outlined above, a distributed architecture is employed.</p><ul><li>UI Client: Users logs into the bioloop application through their web browsers and navigate to the file browser view to initiate file downloads.</li><li>API: This node serves the user interface and API endpoints with user and dataset metadata stored in a PostgreSQL database but does not have direct access to the dataset files.</li><li>Workers / Colo Node: Staging of dataset files occurs on this node via a Celery task. The node also hosts an Nginx server with access to the staged files.</li><li>Signet: An OAuth server supporting client credential flow with download file scope to create secure tokens.</li><li>File Download Server (Nginx): A file server on the colo adjacent to data which receives requests from users to download large dataset files.</li><li>Secure Download API: A lightweight app with one endpoint that validates the incoming requests to the file download server</li></ul><h3 id="_6-downloading-a-dataset-file" tabindex="-1">6. Downloading a Dataset File <a class="header-anchor" href="#_6-downloading-a-dataset-file" aria-label="Permalink to &quot;6. Downloading a Dataset File&quot;">​</a></h3><img src="`+i+'"><p>To download a dataset file:</p><ul><li>Step 1. An authorized user logs in through the UI and requests to download a dataset file.</li><li>Steps 2,3. The API checks if the user has access to the requested file by querying the database and constructs the download file path.</li><li>Step 4,5. Requests the Signet oauth server for a download token with the file path</li><li>Step 6. Responds to UI with the download file url and download token.</li><li>Step 7. UI Client constructs a URL by including the download token as a query parameter and requests the file download server.</li><li>Step 8. File server forwards the request to SecureDownloadAPI for validation.</li><li>Step 9.10. SecureDownloadAPI fetches the public JWT verification keys from the Signet Oauth server in the form of JWKS and perform URL validation as described in section 4.</li><li>Step 11. If it is valid, it responds to file server (Nginx) with a special header x-accel-redirect with a value of the path of the requested file.</li><li>Step 12. Nginx performs internal redirect and sends the requested file to the UIclient with headers invoking a browser file download.</li></ul>',38)]))}const f=t(n,[["render",r]]);export{p as __pageData,f as default};
