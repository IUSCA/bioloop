version: "3"
services:
  ui:
    container_name: dgl_ui
    image: node:19
    volumes:
      - ./ui/:/opt/sca/dgl/ui/
      - dgl_ui_modules:/opt/sca/dgl/ui/node_modules
    ports:
      - 127.0.0.1:443:443
    working_dir: /opt/sca/dgl/ui
    command: sh -c "npm install && npm run dev"
    # entrypoint: [ "tail", "-f", "/dev/null" ]

  api:
    container_name: dgl_api
    image: node:19
    volumes:
      - ./api/:/opt/sca/dgl/api/
      - dgl_api_modules:/opt/sca/dgl/api/node_modules
    expose:
      - 3030
    ports:
      - 127.0.0.1:3030:3030
    working_dir: /opt/sca/dgl/api
    command: sh -c "npm install && npx prisma db push && npx nodemon api.js"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  queue:
    # https://hub.docker.com/_/rabbitmq/
    container_name: dgl_queue
    # includes web gui ?
    image: rabbitmq:3-management
    # image: rabbitmq:3
    ports:
      - 127.0.0.1:5672:5672
      - 127.0.0.1:15672:15672
    volumes:
      - ./db/queue/data/:/var/lib/rabbitmq/
      # - ./db/queue/log/:/var/log/rabbitmq/
    environment:
      - RABBITMQ_DEFAULT_USER=user
      - RABBITMQ_DEFAULT_PASS=password

  worker_api:
    container_name: dgl_worker_api
    build:
      context: ./worker/
      dockerfile: Dockerfile
    volumes:
      - ./worker/scaworkers/:/opt/sca/app/scaworkers
      - ./worker/.env:/opt/sca/app/.env
    expose:
      - 5001
    environment:
      - PORT=5001
    depends_on:
      - queue
      - mongo
    # restart: on-failure

  postgres:
    container_name: dgl_postgres
    image: postgres:14.5
    # restart: unless-stopped
    environment:
      - POSTGRES_USER=dgluser
      - POSTGRES_PASSWORD=example
      - POSTGRES_DB=dgl
    volumes:
      - ./db/db_postgres:/var/lib/postgresql/data
    ports:
      - 127.0.0.1:5432:5432
    expose:
      - 5432

  mongo:
    # https://hub.docker.com/_/mongo
    container_name: dgl_celery_mongo
    image: mongo:5
    ports:
      # helpful for using a GUI client like compass for troubleshooting
      - 127.0.0.1:27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
    volumes:
      - ./db/db_mongo:/data/db
      # for importing database files
      # - ./db/mongodump:/opt/sca/dgl/mongodump


volumes:
  dgl_ui_modules:
    external: false

  dgl_api_modules:
    external: false
